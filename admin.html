<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin — Dashboard</title>
  <link rel="stylesheet" href="admin.css">
  <script src="admin.js" defer></script>
</head>
<body onload="checkAuthOrRedirect()">
  <div class="topbar">
    <div class="brand">SV Legal — Dashboard</div>
    <div class="nav">
      <a href="/admin.html" class="active">Dashboard</a>
      <a href="/admin-requests.html">Requests</a>
      <a href="/admin-calls.html">Calls</a>
      <a href="/admin-appointments.html">Appointments</a>
      <a href="#" onclick="localStorage.removeItem('sv_admin'); location.href='/admin-login.html'">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card">
        <div class="kpi" id="kpi_total">—</div>
        <div class="kpi-sub">Total Requests</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpi_today">—</div>
        <div class="kpi-sub">Requests Today</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpi_pending">—</div>
        <div class="kpi-sub">Pending</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpi_calls">—</div>
        <div class="kpi-sub">Calls Logged</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>Latest Requests</b></div>
        <div>
          <button onclick="loadRequestsPage()">Open Requests</button>
          <button onclick="openLogCallModal()">Log Call</button>
          <button onclick="openAddAppointment()">Add Appointment</button>
        </div>
      </div>
      <div class="table-wrap" id="latestRequestsWrap" style="margin-top:12px"></div>
    </div>

    <div class="footer">SV Legal Admin • built for speed</div>
  </div>

<script>
async function loadDashboard() {
  try {
    const reqs = await apiGet("/requests");
    const calls = await apiGet("/calls");
    const appts = await apiGet("/appointments");

    document.getElementById("kpi_total").innerText = reqs.length;
    const today = new Date().toISOString().slice(0,10);
    document.getElementById("kpi_today").innerText = reqs.filter(r=>r.createdAt && r.createdAt.startsWith && r.createdAt.startsWith(today)).length || 0;
    document.getElementById("kpi_pending").innerText = reqs.filter(r => (r.status||"pending") === "pending").length;
    document.getElementById("kpi_calls").innerText = calls.length;

    // show 6 latest
    const latest = reqs.slice(0,6);
    let html = `<table><thead><tr><th>Name</th><th>Type</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
    latest.forEach(r=>{
      html += `<tr>
                <td>${r.name}</td>
                <td>${r.formType}</td>
                <td>${new Date(r.createdAt).toLocaleString()}</td>
                <td class="row-actions">
                  <button class="btn-view" onclick='openTimeline("${r.mobile}")'>Timeline</button>
                  <button class="btn-approve" onclick='updateStatus("${r._id}","completed")'>Mark Done</button>
                </td>
              </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById("latestRequestsWrap").innerHTML = html;

  } catch(e) { alert("Failed to load dashboard"); }
}

function loadRequestsPage(){ location.href="/admin-requests.html"; }

loadDashboard();
</script>
</body>
</html>
